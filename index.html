<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Psychedelic Image Morph Generator</title>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background-color: #111;
    color: #eee;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  .container { display: flex; flex: 1; overflow: hidden; }
  .sidebar {
    width: 320px; background: #1c1c1c; padding: 15px;
    box-sizing: border-box; overflow-y: auto;
  }
  h2 { margin: 10px 0; font-size: 1.1em; color: #ff66cc; }
  .section { margin-bottom: 20px; }
  label { display: flex; align-items: center; margin-bottom: 8px; }
  input[type="checkbox"] { margin-right: 8px; }
  input[type="range"] { flex: 1; margin-left: 10px; }
  .slider-container { display: flex; align-items: center; margin-bottom: 8px; }
  .color-picker { margin-bottom: 10px; }
  canvas { flex: 1; background: #000; display: block; }
  button {
    background: #ff66cc; border: none; padding: 8px 12px;
    margin: 3px 3px 3px 0; border-radius: 4px; font-weight: bold;
    cursor: pointer; color: #111;
  }
  button:hover { background: #ff33aa; }
  input[type="file"], input[type="number"], select {
    margin-top: 5px; padding: 4px; border-radius: 4px; border: none;
  }
</style>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <button id="randomBtn">ðŸŽ² Random</button>

    <!-- Bild -->
    <div class="section">
      <h2>Bild</h2>
      <input type="file" id="uploadImg" accept="image/*"><br>
      <label>QualitÃ¤t Export:
        <select id="exportQuality">
          <option value="0.6">Mittel</option>
          <option value="0.8" selected>Hoch</option>
          <option value="1.0">Sehr hoch</option>
        </select>
      </label><br>
      <button id="downloadImg">Bild herunterladen</button>
    </div>

    <!-- Morph -->
    <div class="section">
      <h2>Morph</h2>
      <div class="slider-container">
        <label>Fraktal â†” Bild <input type="range" id="morph" min="0" max="100" value="50"></label>
      </div>
    </div>

    <!-- Fraktale -->
    <div class="section">
      <h2>Fraktale</h2>
      <label><input type="checkbox" class="fractal" value="mandelbrot">Mandelbrot</label>
      <label><input type="checkbox" class="fractal" value="julia">Julia</label>
      <label><input type="checkbox" class="fractal" value="kaleidoskop">Kaleidoskop</label>
      <label><input type="checkbox" class="fractal" value="sierpinski">Sierpinski</label>
      <label><input type="checkbox" class="fractal" value="koch">Koch</label>
    </div>

    <!-- Effekte -->
    <div class="section">
      <h2>Effekte</h2>
      <div class="color-picker">PrimÃ¤rfarbe: <input type="color" id="primaryColor" value="#ff66cc"></div>
      <div class="color-picker">SekundÃ¤rfarbe: <input type="color" id="secondaryColor" value="#66ccff"></div>
      <div class="slider-container"><label>SÃ¤ttigung <input type="range" id="saturation" min="0" max="200" value="100"></label></div>
      <div class="slider-container"><label>Helligkeit <input type="range" id="brightness" min="0" max="200" value="100"></label></div>
      <div class="slider-container"><label>Kontrast <input type="range" id="contrast" min="0" max="200" value="100"></label></div>
      <div class="slider-container"><label>Rauschen <input type="range" id="noise" min="0" max="100" value="0"></label></div>
      <div class="slider-container"><label>Struktur <input type="range" id="structure" min="0" max="100" value="0"></label></div>
      <div class="slider-container"><label>Blur <input type="range" id="blur" min="0" max="10" value="0"></label></div>
    </div>

    <!-- Speicher -->
    <div class="section">
      <h2>Einstellungen</h2>
      <button id="saveSettings">Speichern</button>
      <button id="loadSettings">Laden</button>
    </div>
  </div>
  <canvas id="psyCanvas"></canvas>
</div>

<script>
const canvas = document.getElementById("psyCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth - 320;
canvas.height = window.innerHeight;

let uploadedImg = null;
let sierpPoints = [], kochLines = [];
let time = 0;

// --- Utility ---
function clamp(v,min,max){return Math.min(Math.max(v,min),max);}
function hexToRgb(hex){const b=parseInt(hex.slice(1),16);return{r:(b>>16)&255,g:(b>>8)&255,b:b&255};}

// --- Fraktale ---
function mandelbrot(x,y,maxIter){let a=x,b=y;for(let i=0;i<maxIter;i++){let aa=a*a-b*b+ x;let bb=2*a*b+y;if(aa*aa+bb*bb>16)return i;a=aa;b=bb;}return maxIter;}
function julia(x,y,ca,cb,maxIter){let a=x,b=y;for(let i=0;i<maxIter;i++){let aa=a*a-b*b+ca;let bb=2*a*b+cb;if(aa*aa+bb*bb>16)return i;a=aa;b=bb;}return maxIter;}
function sierpinskiPoints(w,h,n=5000){let p=[Math.random()*w,Math.random()*h];let v=[[w/2,0],[0,h],[w,h]];let pts=[];for(let i=0;i<n;i++){let c=v[Math.floor(Math.random()*3)];p=[(p[0]+c[0])/2,(p[1]+c[1])/2];pts.push(p);}return pts;}
function kochSegment(a,b,depth){if(depth==0)return[[a,b]];let dx=(b[0]-a[0])/3,dy=(b[1]-a[1])/3;let p1=[a[0]+dx,a[1]+dy];let p2=[a[0]+2*dx,a[1]+2*dy];let angle=Math.PI/3;let px=p1[0]+Math.cos(angle)*dx-Math.sin(angle)*dy;let py=p1[1]+Math.sin(angle)*dx+Math.cos(angle)*dy;return [...kochSegment(a,p1,depth-1),...kochSegment(p1,[px,py],depth-1),...kochSegment([px,py],p2,depth-1),...kochSegment(p2,b,depth-1)];}
function precompute(){sierpPoints=sierpinskiPoints(canvas.width,canvas.height,4000);kochLines=kochSegment([50,canvas.height-50],[canvas.width-50,canvas.height-50],3);}
precompute();

// --- UI ---
const fractalCheckboxes=document.querySelectorAll(".fractal");
const morphSlider=document.getElementById("morph");
const primaryColor=document.getElementById("primaryColor");
const secondaryColor=document.getElementById("secondaryColor");
const saturation=document.getElementById("saturation");
const brightness=document.getElementById("brightness");
const contrast=document.getElementById("contrast");
const noise=document.getElementById("noise");
const structure=document.getElementById("structure");
const blur=document.getElementById("blur");

// --- Bild Upload ---
document.getElementById("uploadImg").addEventListener("change",e=>{
  const file=e.target.files[0];if(!file)return;
  const img=new Image();
  img.onload=()=>{uploadedImg=img;randomize();};
  img.src=URL.createObjectURL(file);
});

// --- Download ---
document.getElementById("downloadImg").addEventListener("click",()=>{
  const link=document.createElement("a");
  link.download="psychedelic.png";
  link.href=canvas.toDataURL("image/png",parseFloat(document.getElementById("exportQuality").value));
  link.click();
});

// --- Settings Save/Load ---
document.getElementById("saveSettings").addEventListener("click",()=>{
  const settings={morph:morphSlider.value,fractals:[...fractalCheckboxes].map(c=>c.checked),
    colors:[primaryColor.value,secondaryColor.value],sat:saturation.value,bright:brightness.value,cont:contrast.value,
    noise:noise.value,structure:structure.value,blur:blur.value};
  const blob=new Blob([JSON.stringify(settings)],{type:"application/json"});
  const link=document.createElement("a");link.download="settings.json";link.href=URL.createObjectURL(blob);link.click();
});
document.getElementById("loadSettings").addEventListener("click",()=>{
  const inp=document.createElement("input");inp.type="file";inp.accept="application/json";
  inp.onchange=e=>{
    const file=e.target.files[0];if(!file)return;
    const r=new FileReader();r.onload=()=>{
      const s=JSON.parse(r.result);
      morphSlider.value=s.morph;[...fractalCheckboxes].forEach((c,i)=>c.checked=s.fractals[i]);
      primaryColor.value=s.colors[0];secondaryColor.value=s.colors[1];
      saturation.value=s.sat;brightness.value=s.bright;contrast.value=s.cont;
      noise.value=s.noise;structure.value=s.structure;blur.value=s.blur;
    };r.readAsText(file);
  };inp.click();
});

// --- Random ---
function randomize(){
  fractalCheckboxes.forEach(c=>c.checked=Math.random()>0.5);
  primaryColor.value="#"+Math.floor(Math.random()*16777215).toString(16).padStart(6,"0");
  secondaryColor.value="#"+Math.floor(Math.random()*16777215).toString(16).padStart(6,"0");
  [saturation,brightness,contrast,noise,structure,blur].forEach(s=>s.value=Math.floor(Math.random()*s.max));
  morphSlider.value=Math.floor(Math.random()*100);
}
document.getElementById("randomBtn").addEventListener("click",randomize);

// --- Draw ---
function draw(){
  const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);
  if(uploadedImg) ctx.drawImage(uploadedImg,0,0,w,h);
  let imgData=ctx.getImageData(0,0,w,h),data=imgData.data;
  const morph=parseInt(morphSlider.value)/100;
  const prim=hexToRgb(primaryColor.value),sec=hexToRgb(secondaryColor.value);

  for(let y=0;y<h;y+=2){
    for(let x=0;x<w;x+=2){
      let idx=(y*w+x)*4;
      let r=data[idx],g=data[idx+1],b=data[idx+2];

      let fr=0,fg=0,fb=0;
      if(fractalCheckboxes[0].checked){let m=mandelbrot((x-w/2)/w*3,(y-h/2)/h*2,30)/30;fr+=m*255;fg+=m*128;fb+=m*200;}
      if(fractalCheckboxes[1].checked){let j=julia((x-w/2)/w*3,(y-h/2)/h*2,-0.7,0.27015,30)/30;fr+=j*200;fg+=j*255;fb+=j*128;}
      if(fractalCheckboxes[2].checked){let ang=Math.atan2(y-h/2,x-w/2)*6;let rad=Math.sqrt((x-w/2)**2+(y-h/2)**2);fr+=Math.sin(rad/50+ang+time)*127+128;fg+=Math.cos(rad/60+time)*127+128;fb+=Math.sin(rad/40+time)*127+128;}
      if(fractalCheckboxes[3].checked && Math.random()<0.001){r=prim.r;g=prim.g;b=prim.b;}
      if(fractalCheckboxes[4].checked && Math.random()<0.001){r=sec.r;g=sec.g;b=sec.b;}

      r=r*(1-morph)+fr*morph;g=g*(1-morph)+fg*morph;b=b*(1-morph)+fb*morph;

      let sat=saturation.value/100,br=brightness.value/100,cont=contrast.value/100;
      r=(r-128)*cont+128;g=(g-128)*cont+128;b=(b-128)*cont+128;
      r*=sat;br*=sat;b*=sat;r*=br;g*=br;b*=br;

      r+= (Math.random()-0.5)*noise.value;g+= (Math.random()-0.5)*noise.value;b+= (Math.random()-0.5)*noise.value;

      data[idx]=clamp(r,0,255);data[idx+1]=clamp(g,0,255);data[idx+2]=clamp(b,0,255);
    }
  }
  ctx.putImageData(imgData,0,0);

  if(blur.value>0){ctx.filter=`blur(${blur.value}px)`;ctx.drawImage(canvas,0,0);ctx.filter="none";}
  if(structure.value>0){ctx.globalAlpha=structure.value/100;ctx.strokeStyle="rgba(255,255,255,0.1)";for(let i=0;i<50;i++){ctx.beginPath();ctx.moveTo(Math.random()*w,Math.random()*h);ctx.lineTo(Math.random()*w,Math.random()*h);ctx.stroke();}ctx.globalAlpha=1;}

  time+=0.01;
  requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
