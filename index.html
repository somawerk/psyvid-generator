<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Psychedelic Image Morpher</title>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background-color: #111;
    color: #eee;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  .container { display: flex; flex: 1; overflow: hidden; }
  .sidebar {
    width: 300px; background-color: #1c1c1c;
    padding: 20px; box-sizing: border-box; overflow-y: auto;
  }
  h2 { margin-top: 0; font-size: 1.2em; color: #ff66cc; }
  .section { margin-bottom: 20px; }
  label { display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; }
  input[type="checkbox"] { margin-right: 10px; }
  .slider-container { display: flex; align-items: center; margin-bottom: 10px; }
  .slider-container input[type="range"] { flex: 1; margin-left: 10px; }
  .color-picker { display: flex; align-items: center; margin-bottom: 10px; }
  canvas { flex: 1; display: block; background-color: #000; }
  button {
    background-color: #ff66cc; border: none; padding: 10px 15px;
    color: #111; cursor: pointer; margin-right: 10px; margin-top: 5px;
    border-radius: 4px; font-weight: bold;
  }
  button:hover { background-color: #ff33aa; }
  input[type="number"], select {
    width: 80px; margin-left: 10px; border-radius: 4px;
    border: none; padding: 3px;
  }
</style>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <button id="randomize">ðŸŽ² Random</button>

    <!-- Bild -->
    <div class="section">
      <h2>Bild</h2>
      <input type="file" id="uploadImage" accept="image/*"><br>
      <button id="downloadImage">Download</button>
      <label>QualitÃ¤t:
        <select id="downloadQuality">
          <option value="1">100%</option>
          <option value="0.9" selected>90%</option>
          <option value="0.75">75%</option>
          <option value="0.5">50%</option>
        </select>
      </label>
    </div>

    <!-- Morph -->
    <div class="section">
      <h2>Morphing</h2>
      <div class="slider-container">
        <label>Fraktal â†” Bild
          <input type="range" id="morphSlider" min="0" max="100" value="50">
        </label>
      </div>
    </div>

    <!-- Fraktale -->
    <div class="section">
      <h2>Fraktale</h2>
      <label><input type="checkbox" class="fractal" value="mandelbrot">Mandelbrot</label>
      <label><input type="checkbox" class="fractal" value="julia">Julia</label>
      <label><input type="checkbox" class="fractal" value="kaleidoskop">Kaleidoskop</label>
      <label><input type="checkbox" class="fractal" value="sierpinski">Sierpinski</label>
      <label><input type="checkbox" class="fractal" value="koch">Koch</label>
    </div>

    <!-- Effekte -->
    <div class="section">
      <h2>Effekte</h2>
      <div class="color-picker">PrimÃ¤r: <input type="color" id="primaryColor" value="#ff66cc"></div>
      <div class="color-picker">SekundÃ¤r: <input type="color" id="secondaryColor" value="#66ccff"></div>
      <div class="slider-container">SÃ¤ttigung <input type="range" id="saturation" min="0" max="200" value="100"></div>
      <div class="slider-container">Helligkeit <input type="range" id="brightness" min="0" max="200" value="100"></div>
      <div class="slider-container">Kontrast <input type="range" id="contrast" min="0" max="200" value="100"></div>
      <div class="slider-container">Rauschen <input type="range" id="noise" min="0" max="100" value="10"></div>
      <div class="slider-container">Struktur <input type="range" id="structure" min="0" max="100" value="0"></div>
      <div class="slider-container">Blur <input type="range" id="blur" min="0" max="10" value="0"></div>
    </div>

    <!-- Speicher -->
    <div class="section">
      <h2>Speicher</h2>
      <button id="saveSettings">Speichern</button>
      <button id="loadSettings">Laden</button>
    </div>
  </div>
  <canvas id="psyCanvas"></canvas>
</div>

<script>
const canvas=document.getElementById('psyCanvas'), ctx=canvas.getContext('2d');
function resize(){canvas.width=window.innerWidth-300;canvas.height=window.innerHeight;}
window.addEventListener('resize',resize);resize();

let time=0, uploadedImg=null;
const fractalCheckboxes=document.querySelectorAll('.fractal');
const morphSlider=document.getElementById('morphSlider');
const primaryColor=document.getElementById('primaryColor');
const secondaryColor=document.getElementById('secondaryColor');
const saturation=document.getElementById('saturation');
const brightness=document.getElementById('brightness');
const contrast=document.getElementById('contrast');
const noise=document.getElementById('noise');
const structure=document.getElementById('structure');
const blur=document.getElementById('blur');

function clamp(v,min,max){return Math.min(Math.max(v,min),max);}
function hexToRgb(hex){const b=parseInt(hex.slice(1),16);return{r:(b>>16)&255,g:(b>>8)&255,b:b&255};}

// Fraktale
function mandelbrot(x,y,max){let a=x,b=y;for(let i=0;i<max;i++){let aa=a*a-b*b+x;let bb=2*a*b+y;a=aa;b=bb;if(a*a+b*b>16)return i;}return max;}
function julia(x,y,ca,cb,max){let a=x,b=y;for(let i=0;i<max;i++){let aa=a*a-b*b+ca;let bb=2*a*b+cb;a=aa;b=bb;if(a*a+b*b>16)return i;}return max;}

// Draw Loop
function draw(){
  const w=canvas.width,h=canvas.height;
  const scale=1; // performance-scaling
  const ow=Math.floor(w*scale),oh=Math.floor(h*scale);
  let off=document.createElement("canvas");off.width=ow;off.height=oh;
  let octx=off.getContext("2d");

  if(uploadedImg) octx.drawImage(uploadedImg,0,0,ow,oh);
  let imgData=octx.getImageData(0,0,ow,oh),data=imgData.data;

  const morph=parseInt(morphSlider.value)/100;
  const prim=hexToRgb(primaryColor.value), sec=hexToRgb(secondaryColor.value);

  for(let y=0;y<oh;y++){
    for(let x=0;x<ow;x++){
      let idx=(y*ow+x)*4;
      let r=data[idx], g=data[idx+1], b=data[idx+2];
      let fr=0,fg=0,fb=0;

      if(fractalCheckboxes[0].checked){let m=mandelbrot((x-ow/2)/ow*3,(y-oh/2)/oh*2,30)/30;fr+=m*255;fg+=m*128;fb+=m*200;}
      if(fractalCheckboxes[1].checked){let j=julia((x-ow/2)/ow*3,(y-oh/2)/oh*2,-0.7,0.27015,30)/30;fr+=j*200;fg+=j*255;fb+=j*128;}
      if(fractalCheckboxes[2].checked){let ang=Math.atan2(y-oh/2,x-ow/2)*6;let rad=Math.sqrt((x-ow/2)**2+(y-oh/2)**2);fr+=Math.sin(rad/50+ang+time)*127+128;fg+=Math.cos(rad/60+time)*127+128;fb+=Math.sin(rad/40+time)*127+128;}
      if(fractalCheckboxes[3].checked && Math.random()<0.0005){r=prim.r;g=prim.g;b=prim.b;}
      if(fractalCheckboxes[4].checked && Math.random()<0.0005){r=sec.r;g=sec.g;b=sec.b;}

      r=r*(1-morph)+fr*morph;
      g=g*(1-morph)+fg*morph;
      b=b*(1-morph)+fb*morph;

      let sat=saturation.value/100, br=brightness.value/100, cont=contrast.value/100;
      r=(r-128)*cont+128; g=(g-128)*cont+128; b=(b-128)*cont+128;
      r*=sat; g*=sat; b*=sat; r*=br; g*=br; b*=br;

      r+=(Math.random()-0.5)*noise.value; g+=(Math.random()-0.5)*noise.value; b+=(Math.random()-0.5)*noise.value;

      data[idx]=clamp(r,0,255);
      data[idx+1]=clamp(g,0,255);
      data[idx+2]=clamp(b,0,255);
    }
  }

  octx.putImageData(imgData,0,0);

  ctx.imageSmoothingEnabled=true;
  ctx.clearRect(0,0,w,h);
  ctx.drawImage(off,0,0,w,h);

  if(blur.value>0){ctx.filter=`blur(${blur.value}px)`;ctx.drawImage(canvas,0,0);ctx.filter="none";}
  if(structure.value>0){ctx.globalAlpha=structure.value/100;ctx.strokeStyle="rgba(255,255,255,0.1)";
    for(let i=0;i<50;i++){ctx.beginPath();ctx.moveTo(Math.random()*w,Math.random()*h);ctx.lineTo(Math.random()*w,Math.random()*h);ctx.stroke();}
    ctx.globalAlpha=1;}

  time+=0.01;
  requestAnimationFrame(draw);
}
draw();

// Upload
document.getElementById('uploadImage').addEventListener('change',e=>{
  const file=e.target.files[0]; if(!file)return;
  const img=new Image(); img.onload=()=>{uploadedImg=img;}; img.src=URL.createObjectURL(file);
});

// Download
document.getElementById('downloadImage').addEventListener('click',()=>{
  const q=parseFloat(document.getElementById('downloadQuality').value);
  const link=document.createElement('a');
  link.download="psychedelic.png";
  link.href=canvas.toDataURL("image/png",q);
  link.click();
});

// Settings Save/Load
document.getElementById('saveSettings').addEventListener('click',()=>{
  const settings={morph:morphSlider.value,fractals:[...fractalCheckboxes].map(c=>c.checked),
    colors:[primaryColor.value,secondaryColor.value],saturation:saturation.value,
    brightness:brightness.value,contrast:contrast.value,noise:noise.value,structure:structure.value,blur:blur.value};
  localStorage.setItem('psySettings',JSON.stringify(settings));
  alert("Einstellungen gespeichert");
});
document.getElementById('loadSettings').addEventListener('click',()=>{
  const s=JSON.parse(localStorage.getItem('psySettings')||"null"); if(!s)return alert("Keine Settings gespeichert");
  morphSlider.value=s.morph; [...fractalCheckboxes].forEach((c,i)=>c.checked=s.fractals[i]);
  primaryColor.value=s.colors[0]; secondaryColor.value=s.colors[1];
  saturation.value=s.saturation; brightness.value=s.brightness; contrast.value=s.contrast;
  noise.value=s.noise; structure.value=s.structure; blur.value=s.blur;
  alert("Einstellungen geladen");
});

// Randomize
document.getElementById('randomize').addEventListener('click',()=>{
  morphSlider.value=Math.floor(Math.random()*101);
  [...fractalCheckboxes].forEach(c=>c.checked=Math.random()>0.5);
  primaryColor.value='#'+Math.floor(Math.random()*16777215).toString(16).padStart(6,'0');
  secondaryColor.value='#'+Math.floor(Math.random()*16777215).toString(16).padStart(6,'0');
  saturation.value=Math.floor(Math.random()*201);
  brightness.value=Math.floor(Math.random()*201);
  contrast.value=Math.floor(Math.random()*201);
  noise.value=Math.floor(Math.random()*101);
  structure.value=Math.floor(Math.random()*101);
  blur.value=Math.floor(Math.random()*11);
});
</script>
</body>
</html>
